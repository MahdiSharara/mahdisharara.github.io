name: Update Google Scholar Stats

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install scholarly "httpx<0.28.0"

      - name: Fetch Google Scholar stats
        timeout-minutes: 5
        run: |
          python << 'EOF'
          import json
          from datetime import date
          from scholarly import scholarly, ProxyGenerator

          # Set up free proxy to avoid blocking
          pg = ProxyGenerator()
          try:
              success = pg.FreeProxies()
              scholarly.use_proxy(pg)
              print("Using free proxy")
          except Exception as e:
              print(f"Proxy setup failed: {e}, trying without proxy")

          try:
              print("Fetching author data...")
              author = scholarly.search_author_id('mrGL-KcAAAAJ')
              author = scholarly.fill(author, sections=['basics', 'indices'])

              citations = author.get('citedby', 0)
              h_index = author.get('hindex', 0)
              i10_index = author.get('i10index', 0)

              stats = {
                  "citations": str(citations),
                  "hIndex": str(h_index),
                  "i10Index": str(i10_index),
                  "lastUpdated": str(date.today())
              }

              print(f"Fetched stats: {stats}")

              with open('scholar-stats.json', 'w') as f:
                  json.dump(stats, f, indent=2)

              print("Successfully updated scholar-stats.json")

          except Exception as e:
              print(f"Error fetching stats: {e}")
              print("Keeping existing values")
              exit(0)
          EOF

      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add scholar-stats.json
          git diff --staged --quiet || git commit -m "Update Google Scholar stats"
          git push
